#!/bin/sh

date

MBSYNC=$(pgrep mbsync)
NOTMUCH=$(pgrep notmuch)

if [ -n "$MBSYNC" -o -n "$NOTMUCH" ]; then
   echo "Already running one instance of checkmail. Exiting..."
   exit 0
fi

JQ_CMD='.[] | "<b>From</b>: \(.authors)\\\\n<b>Time</b>: \(.date_relative)\\\\n<b>Subject</b>: \(.subject)"'

mbsync --all --verbose
notmuch new

notmuch search --format=json tag:unread and tag:unnotified \
    | jq -r "$JQ_CMD" \
    | while read line; do notify-send "New email" "${line}"; done

notmuch tag -unnotified -- tag:unnotified
